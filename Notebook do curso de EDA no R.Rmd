---
title: "Análise Exploratória de Dados no R"
author: "Filipe C. L. Duarte"
date: "27 de julho de 2019"
output:
  prettydoc::html_pretty:
    df_print: paged
    theme: hpstr
    toc: yes
    toc_depth: 2
  pdf_document:
    toc: yes
    toc_depth: '2'
---

# Introdução

Me chamo Filipe, sou professor da Universidade Federal da Paraíba e leciono disciplinas no curso de Ciências Atuariais. Atualmente, desenvolvo pesquisas na área de aprendizagem de máquina, atuária e finanças. 

### Pré-requisitos

Você precisa conhecer as estruturas de dados básicas utilizadas no `R` como **variável**, **vetor** e **data frame**, além de saber implementar algumas rotinas como a criação de variáveis, filtragem de objetos em um data frame e criação de funções.

### Conteúdo

Este curso aborda os seguintes tópicos:

1. Preparação dos dados
2. Estatística descritiva
3. Visualização de dados com o ggplot2
4. Histograma 
5. Box-plot
6. Gráfico de barras
7. Gráfico de Dispersão

Primeiramente, iremos organizar os dados para, em seguida, introduzir as funções básicas do `R` que calculam as estatísticas descritivas. Após essa introdução, ensinaremos como criar uma rotina para calcular as estatísticas para uma ou mais variáveis.

Após aprendermos a utilizar o `R` para estruturar os dados calcular as estatísticas descritivas, vamos entender como funciona o `ggplot2`, a melhor biblioteca para visualização de dados. 

# 1. Preparação dos dados

Esta parte será dedicada ao processo de organização, limpeza e estruturação dos dados. Normalmente, é um dos procedimentos mais trabalhosos e é implementado quando os dados apresentam informações incorretas para uma ou mais mais observações (exemplos), ou então quando faltam informações. 

Além disso, as tabelas, muitas vezes, não estão estruturadas no modelo padrão, onde cada linha representa um indivíduo (exemplo) e as colunas configuram as variáveis ou características dos indivíduos.  

Dessa feita, vamos iniciar o nosso trabalho a partir de uma base de dados de participantes, na qualidade de ativos, de um plano de previdência. O arquivo foi denominado **BasePens.csv** e precisa ser importado para o `R`.
Nossa base possui 749 pessoas e 8 variáveis tais quais:

- ID - representa a identificação do participante
- SEXO - 1 para o sexo feminino, 2 para o masculino
- ESTADO.CIVIL - 1 para solteiro(a); 2 para casado(a); 3 para viúvo(a); 4 para separado(a) judicialmente; 5 para divorciado(a); 6 para união estável; e 9 outros 
- DATA.DE.NASCIMENTO.dd.mm.aaaa - data de nascimento do participante, no formato dd/mm/aaaa
- DATA.DE.INGRESSO.NO.FUNDO.dd.mm.aaaa - data de ingresso no plano previdenciário, no formato dd/mm/aaaa
- CARREIRA.ATUAL - função exercída (profissão)
- BASE.DE.CALCULO.MENSAL - salário de contribuição para a previdência
- NÚMERO.DE.DEPENDENTES - quantidade de dependentes do participante (elegíveis para pensão)

Para importar a base pelo `R`, vamos usar a função `read.csv`.

```{r, message = FALSE}
dados <- read.csv2("BasePens.csv", sep = ";", header = TRUE)
```

Fizemos a utilização da função `read.csv2`, pois nossa base tinha sido salva com a virgula como separador decimal. Caso sua base esteja no modelo americano, isto é, com o ponto como o separador decimal, utilize a função `read.csv`.

Agora vamos visualizar se a importação da base foi realizada de forma correta, através da função `str` que nos apresenta a estrutura dos dados.

```{r}
# estrutura dos dados
str(dados)
```

Percebe-se que a importação foi um sucesso, contudo não podemos dizer o mesmo quanto à leitura. A variável `SEXO` e `ESTADO.CIVIL` foram importadas como número inteiro; a `DATA.DE.NASCIMENTO.dd.mm.aaaa...`, `DATA.DE.INGRESSO.NO.FUNDO.dd.mm.aaaa` foram importadas como *factor* que é o formato utilizado pelo `R` para trabalhar com dados qualitativos. 

Antes de realizar os ajustes necessários, vamos visualizar as 6 primeiras linhas da base:

```{r}
# mostrar as 6 primeiras linhas
head(dados)
# visualizar o nome das variáveis (colunas)
names(dados)
```

Vamos renomear as variáveis para que o processo de limpeza seja feito de maneira mais fácil, e em seguida vamos mostrar novamente os nomes, as 6 primeiras linhas e a estrutura dos dados: 

```{r}
# vamos renomear as variáveis
names(dados) <- c("id", "sexo", "EstadoCivil", "DataNascimento", 
                  "DataIngresso", "carreira", "BaseCalculoMensal", "QntDependentes")

# vendo novamente as variáveis
names(dados)
head(dados)
str(dados)
```

O próximo passo será alterar o tipo das variáveis `sexo` e `EstadoCivil` para `factor` e codificar corretamente as categorias (atribuir o nome correto à categoria): 

```{r}
# Vamos transformar a variável sexo para factor (qualitativa) 
dados$sexo <- ifelse(dados$sexo == 1, "feminino", "masculino")
dados$sexo <- as.factor(dados$sexo)

# Vamos transformar a variável estado civil para factor
dados$EstadoCivil <- ifelse(dados$EstadoCivil == 1, "solteir", 
                     ifelse(dados$EstadoCivil == 2, "casad", 
                     ifelse(dados$EstadoCivil == 3, "viuv",
                     ifelse(dados$EstadoCivil == 4, "sepjudicialmente", 
                     ifelse(dados$EstadoCivil == 5, "divorciad", 
                     ifelse(dados$EstadoCivil == 6, "uniaoestavel", "outros"))))))

# Transformando a variável estado civil para factor
dados$EstadoCivil <- as.factor(dados$EstadoCivil)

```

Desejando visualizar novamente a estrutura dos dados e as 6 primeiras linhas, utilize a função `str` e `head`:

```{r}
str(dados)
head(dados)
```


O segundo procedimento de estruturação da nossa base será transformar as variáveis `DataNascimento` e `DataIngresso` para um formato que o `R` entenda como uma data. Ao mesmo tempo, precisaremos calcular a idade atual dos participantes. 

Para tanto, vamos dizer ao `R` para criar uma variável com a data de hoje. Em seguida, iremos calcular a diferença, em anos, entre a data de hoje e a data de nascimento de cada participante do plano, transformando a variável `idade` para o tipo inteiro.

```{r}
# Datas de referência no R e data de hoje
data_hoje <- Sys.Date()

# Ajustando a data de ingresso e de nascimento
dados$DataNascimento <- as.Date(dados$DataNascimento, format = "%d/%m/%Y")
dados$DataIngresso <- as.Date(dados$DataIngresso, "%d/%m/%Y")

# Calculando a idade dos participantes do plano
dados$idade <- as.numeric(round((data_hoje - dados$DataNascimento)/365,0))
str(dados)
```

Agora é sua vez, calcule o tempo de contribuição, em anos, para cada participante e salve como uma variável da sua base com o nome `temposervico`. Após, mostre a estrutura dos dados e as 6 primeiras linhas da base.

```{r}
##### Exercício: Calcule a quantidade de tempo de serviço passado para os participantes
dados$temposervico <- as.numeric(round((data_hoje - dados$DataIngresso)/365,0))

```

Até agora foi moleza, certo? Agora, crie uma variável que represente o salário de contribuição anual dos participantes do plano e a adicione à base, considerando que todos recebem o 13º salário. 

```{r}
##### Exercício: Crie uma coluna (variável) representando a Base de Cálculo Anual, considerando o 13º salário
dados$BaseCalculoAnual <- dados$BaseCalculoMensal * 13
```

Finalizaremos o procedimento de *data wrangling*, exportando, por meio da função `write.table`, a base estruturada para um arquivo com extensão **.csv** com o nome "dados.csv".  

```{r}
# Vamos salvar essa planilha final 
write.table(x = dados, file = "dados.csv")
```


#### Referências

* Kabacoff, R. I. **R in Action: Data Analysis and graphics with R**. Second Edition. Manning Publications Co, 2015.
* [Wickham, H. Grolemund, G. **R for Data Science**](https://r4ds.had.co.nz/)

# 2. Análise Exploratória de Dados

Quando você possuir dados estruturados e for analisá-los, você deve, primeiramente, descrevê-los, seja por meio das estatísticas descritivas ou por gráficos. Desse modo, você poderá observar as relações entre as variáveis selecionadas, sejam elas quantitativas ou qualitativas. Assim, o objetivo da análise exploratória de dados é responder perguntas como:

* Qual a correlação entre o PIB e a expectativa de vida? 
* Como é a família padrão atualmente? Em média, quantos filhos? Qual a porcentagem de pessoas casadas?
* Qual ação apresenta maior rentabilidade nos últimos 12 meses?
* Qual o valor médio de um sinistro de automóvel?

Nesta seção, vamos revisar algumas funções no R para calcular as estatísticas descritivas. Funções como a média, mediana, variância, desvio-padrão, mínino, máximo etc. Essas estatísticas são utilizadas quando dispomos de variáveis quantitativas. 

Certo, aí você me pergunta: Quais as métricas quando possuímos variáveis qualitativas? Bem, nós estudaremos em seguida. Para tratar de variáveis qualitativas, temos a disposição a tabela de frequência e contingência. 

Quem precisar se aprofundar neste conteúdo, recomendo que busque os seguintes materiais:

#### Referências

* [Bussab, W. D. O.; Morettin, P. A. **Estatística Básica**. Saraiva, 9ª ed. 2017.](https://www.google.com/search?ei=h6AoXYOIJq665OUPo4OLuAY&q=Morettin+e+Bussab+Estat%C3%ADstica+B%C3%A1sica&oq=Morettin+e+Bussab+Estat%C3%ADstica+B%C3%A1sica&gs_l=psy-ab.3..35i39j0l9.6783.12273..12415...0.0..0.404.6229.2-23j0j1......0....1..gws-wiz.......0i71.vPERBmd3PCA)
* [Magalhães, M. N.; Lima, A. C. P. **Noções de Probabilidade e Estatística**. Edusp, 7ª ed., 2010](http://www.edusp.com.br/loja/produto/356/nocoes-de-probabilidade-e-estatistica)

## Estatística Descritiva

Bem, já estruturamos os nossos dados e agora podemos importá-los a partir do novo arquivo - `dados.csv`. Lembre-se de verificar o separador decimal para aplicar a função correta. 

```{r message = FALSE}
# Importando os dados
dados <- read.csv("dados.csv", header = TRUE, sep = "")
```

Utilizamos a função `read.csv`, em razão da base utilizar o ponto `.` como separador decimal. Diferentemente de `BasePens.csv`, `dados.csv` foi gerada a partir do `R` pelo modelo americano. 

Antes de adentrar nas funções estatísticas, vamos visualizar a nossa base, mostrando as 6 primeiras e as 6 últimas linhas.

```{r}
# visualizando as 6 primeiras linhas
head(dados)
# visualizando as 6 últimas linhas
tail(dados)
```

A partir de agora, vamos criar uma nova tabela de dados (**data frame**) com as variáveis de interesse. Para criar de forma organizada essa tabela, iniciaremos salvando um vetor (`vars`) com o nome, entre aspas (tipo `string`), das colunas (variáveis) que comporão a nova tabela. Em seguida, crie um novo objeto a partir da tabela de dados, indexado pelo vetor com as variáveis (`vars`).

```{r}
vars <- c("id", "sexo", "EstadoCivil", "carreira", "QntDependentes", "idade","temposervico","BaseCalculoMensal")
# Salvar a nova tabela de dados
dados_estat <- dados[, vars]

# vendo as 6 primeiras linhas
head(dados_estat)

# vendo as carreiras - valores únicos
unique(dados_estat$carreira)
```

Exercício:


* Mostre quais são estados civis presentes na base.


```{r}

```

A estatística descritiva faz parte da análise exploratória de dados. Ela nos fornece resumos simples sobre a amostra e sobre as observações que foram ajustadas. Sendo assim, ela pode ser quantitativa ou visual (seção de visualização de dados com o `ggplot2`).

O primeiro comando que vamos utilizar é o `summary`, que serve para realizar uma descrição quantitativa da distribuição dos dados. Se a variável for quantitativa, essa função nos fornecerá informações como:

* Mínimo
* 1º Quartil
* Mediana
* Média
* 3º Quartil
* Máximo

Caso a variável seja qualitativa, ela irá retornar a quantidade de observações para cada categoria. 

Abaixo, executaremos a função `summary` em todas as variáveis:

```{r}
# sumarizando os dados
summary(dados_estat)
```

Sua vez de praticar. Escreva o código no espaço de código abaixo:

```{r}
# Exercício: Mostre o sumário da variável Base de Cálculo Mensal

```

Perceba que algumas variáveis apresentam informações sobre NA's. NA é a forma como o R codifica informações faltantes. Por exemplo, falta a informação do salário mensal de uma pessoa. Na verdade, na nossa base, verificamos que falta informação a respeito do salário de 5 pessoas.

Como faremos para saber qual foi a linha que apresentou *NA*? Bem, o R nos fornece uma função `is.na` que retorna um valor booleano (lógico), TRUE ou FALSE, caso haja NA. 

Além disso, usaremos a função `which` que retorna a posição (linha) quando uma condição verdadeira é satisfeita. No nosso caso, o código irá retornar a posição (linha) que possuir NA. Em seguida, pediremos para que o R nos mostre as pessoas com informações faltantes.    

```{r}
# Vamos encontrar o NA para o tempo de serviço
which(is.na(dados_estat$temposervico))
# vamos encontrar o NA para a base de cálculo mensal
which(is.na(dados_estat$BaseCalculoMensal))

dados_estat[c(51, 564, 619, 686, 741),]
```

Como eu faria para automatizar esse procedimento? Abaixo, apresento-lhes um código para realizar o subagrupamento de uma forma geral, ou seja, sem declarar explicitamente as posições dos indivíduos como fizemos acima. Lembre-se que pode haver mais de um NA para um indivíduo e você não poderá repetir. 

```{r}
# Repetindo o processo de identificação das linhas com NA's
na_ts <-  which(is.na(dados_estat$temposervico))
na_bcm <- which(is.na(dados_estat$BaseCalculoMensal))

# Vamos juntá-los, isto é, concatenaremos os vetores na_ts e na_bcm
na <- c(na_ts, na_bcm)
# Veja que 51 aparece duas vezes
print(na)

# Agora vamos selecionar os valores sem repetições
na_unique <- unique(na)
# Agora sim!
print(na_unique)

# Selecionando as pessoas que possuem NA (informação faltante)
dados_estat[na_unique,]
```

Então, dado que aprendemos como pedir o sumário e retirar as linhas sem informações, como faço para calcular as estatísticas para cada variável de forma individual? Busque no google, dando preferência pelo [R documentation]<https://www.rdocumentation.org/>, pela função desejada no R. Busque pela função que calcula:

* média
* desvio-padrão
* mínimo
* máximo
* quantidade
* quantis

A seguir, aplicaremos as às variáveis. 


```{r}
# média - mean()
mean(dados_estat$idade)
mean(dados_estat$QntDependentes)
mean(dados_estat$temposervico)
mean(dados_estat$temposervico, na.rm = TRUE)
mean(dados_estat$BaseCalculoMensal)

# desvio padrão - sd()
sd(dados_estat$idade)
sd(dados_estat$QntDependentes)
sd(dados_estat$temposervico, na.rm = TRUE)
sd(dados_estat$BaseCalculoMensal)
sd(dados_estat$BaseCalculoMensal, na.rm = TRUE)

# mínimo - min()
min(dados_estat$idade)
min(dados_estat$temposervico, na.rm = TRUE)
min(dados_estat$BaseCalculoMensal)
min(dados_estat$BaseCalculoMensal, na.rm = TRUE)

# máximo - max()
max(dados_estat$idade)
max(dados_estat$temposervico, na.rm = TRUE)
max(dados_estat$BaseCalculoMensal)
max(dados_estat$BaseCalculoMensal, na.rm = TRUE)

# quantidade - se vetor, length(); se for data frame, use nrow() ou str()
length(dados_estat$idade)
nrow(dados_estat)
str(dados_estat)

# quantis - quantile(dados, probs = c(...))
quantile(dados_estat$idade, probs = seq(0.25, 1, 0.25))
quantile(dados_estat$idade, probs = c(0.1, 0.5, 0.9))
quantile(dados_estat$idade, probs = c(0.01, 0.5, 0.99))

##### Exercício: Mostre os mesmos quantis para a Base de Cálculo Mensal 
quantile(dados_estat$BaseCalculoMensal, probs = seq(0.25, 1, 0.25), na.rm = TRUE)
quantile(dados_estat$BaseCalculoMensal, probs = c(0.1, 0.5, 0.9), na.rm = TRUE)
quantile(dados_estat$BaseCalculoMensal, probs = c(0.01, 0.5, 0.99), na.rm = TRUE)

```

Pesquise no R documentation qual a função que calcula a variância. Em seguida, calcule a variância para:

a. Tempo de Serviço
b. Base de Cálculo Mensal

```{r}
##### Exercício: Calcule a variância para a. Tempo de serviço; b. Base de Cálculo Mensal.
# a.
var(dados_estat$temposervico, na.rm = TRUE)
# b. 
var(dados_estat$BaseCalculoMensal, na.rm = TRUE)
```

Verificamos, inicialmente, que há pessoas com Base de Cálculo igual a 0. Isso deve ter sido um erro cometido durante o preenchimento dos dados. Certo disso, vamos omití-los e calcular os quartis. 

Podemos fazer esse procedimento de duas formas. A primeira consiste em filtrar as linhas diretamente dentro da função `quantile`, utilizando apenas um código. Enquanto que na segunda, faremos o procedimento de filtragem separamente a partir da criação de um vetor com TRUE e FALSE, que avalia a condição da Base de Cálculo Mensal ser igual a 0, para depois chamar a função `quantile` para a base filtrada. Vejamos a seguir:

```{r}
# Primeira:
quantile(dados_estat$BaseCalculoMensal[dados_estat$BaseCalculoMensal != 0], 
         probs = seq(0.25, 1, 0.25), na.rm = TRUE)
quantile(dados_estat$BaseCalculoMensal[dados_estat$BaseCalculoMensal != 0], 
         probs = c(0.01, 0.5, 0.99), na.rm = TRUE)
```


```{r}
# Segunda:
# Criando um vetor lógico com `TRUE` quando a Base de Cálculo Mensal for igual a 0.
base0 <- dados_estat$BaseCalculoMensal == 0
print(base0)

# Por fim, vamos fazer a seleção das linhas diferentes de base0 (que retornaram ), ou seja, selecionaremos as linhas cuja Base de Cálculo Mensal é diferente de 0

quantile(dados_estat$BaseCalculoMensal[!base0], probs = seq(0.25, 1, 0.25), 
         na.rm = TRUE)
quantile(dados_estat$BaseCalculoMensal[!base0], probs = c(0.01, 0.5, 0.99), 
         na.rm = TRUE)
```


```{r}
# Exercício: Apresente as pessoas que possuem a Base de Cálculo igual a 0.
base_zero <- which(dados_estat$BaseCalculoMensal == 0)
dados_estat[base_zero,]
```


Agora vamos construir uma função que calcula as estatísticas utilizadas acima de uma única vez para todas as variáveis. Inicialmente, criaremos uma função com as estatísticas desejadas e usaremos a função `sapply` para aplicá-la em todas as variáveis desejadas.

```{r}
estatisticas <- function(x){
  x <- x[!is.na(x)] # isso serve para que ele omita as observações com NA
  me <- mean(x)
  med <- median(x)
  n <- length(x)
  s <- sd(x)
  mi <- min(x)
  ma <- max(x)
  q25 <- quantile(x, probs = 0.25)
  q75 <- quantile(x, probs = 0.75)
  return(c(n = n, media = me, mediana = med, desvio = s, 
           Q25 = q25, Q75 = q75, min = mi, max = ma))
}
```


## Visualização de dados com ggplot2

A bibiloteca `ggplot2` utiliza da gramática dos gráficos. Ela possui um conjunto de ferramentas que permite a criação de gráficos que capture relações complexas.

```{r pressure, echo=FALSE, fig.cap="Fonte: Gramática dos Gráficos - https://oestatistico.com.br/a-gramatica-dos-graficos/.", out.width = '30%'}
knitr::include_graphics("grammar.png")
```

Portanto, é uma biblioteca muito flexível que foi desenvolvida para que o procedimento de criação dos gráficos seja sistematizado da seguinte forma:

1. Você inicializa a função ggplot() com os dados e pode adicionar diversos elementos de forma encadeada:
    
    ex.: ggplot(data = dados, aes(x = idade, y = BaseCalculoMensal)) 
    
    Essa funcão cria um espaço para você adicionar alguma estrutura. 

2. Se eu quiser adicionar outro elemento, como pontos entre essas variáveis, devemos adicioná-los à p (objeto salvo anteriormente):

    ex.: ggplot(data = dados, aes(x = idade, y = BaseCalculoMensal))  + geom_point() 
  
    Dessa maneira, podemos melhorar o gráfico. 
 
3. É possível modificá-lo? Sim, podemos adicionar um título e alterar o texto dos eixos por meio da função labs(). 

```{r eval = FALSE}
 ggplot(data = dados, aes(x = idade, y = BaseCalculoMensal)) + 
  geom_point() + 
  labs(title = "Gráfico de dispersão", x = "Idade", y = "Base de Cálculo Mensal")
```
 
