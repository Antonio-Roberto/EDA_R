---
title: "Análise Exploratória de Dados no R - Parte 2"
author: "Filipe C. L. Duarte"
date: "24 de agosto de 2019"
output:
  prettydoc::html_pretty:
    df_print: paged
    theme: hpstr
    toc: yes
    toc_depth: 2
---

## Conteúdo

O curso aborda os seguintes tópicos:

1. Preparação dos dados
    + Manipulação de dados com o pacote dplyr
2. Visualização de dados com o ggplot2
    + Histograma 
    + Box-plot
    + Gráfico de barras
    + Gráfico de Dispersão
    

Este curso contempla a 2ª parte do minicurso "Análise Exploratória de Dados no R" realizado em 27 de julho de 2019. Nesse sentido, recomendo que estude a parte 1 do curso antes de iniciar este módulo. Neste, abordaremos a mesma base de dados que foi estruturada na primeira.

### Importação dos dados

Para que possamos utilizar a biblioteca `dplyr`, é necessário que a carregemos. Para tanto, use o comando a seguir:

```{r message=FALSE, results="hide"}
library(dplyr)
```

Ainda, para otimizar a escrita dos códigos dessa biblioteca, vamos utilizar o operador pipe `%>% `. Precisamos carregar o seu pacote, o `magrittr`:

```{r}
library(magrittr)
```

O operador pipe serve para que você consiga trabalhar com diversas funções de uma maneira mais clara, isto é, ele torna o código mais simples de se ler. Assim, ele faz com que a parte do código que esteja à esquerda seja o primeiro argumento da função do lado direito. Por exemplo, sem a utilização do operador pipe, se eu desejar calcular média de um vetor após a aplicação de uma função que divide todos os valores por 100, eu faria:

```{r}
set.seed(100) # serve para que a geração de números aleatórios possa ser reproduzida

# função que divide por 10
div <- function(x){
  return(x/10)
}

# criando o vetor
y <- rnorm(20, 10, 1) # 20 números com média 10 e desvio 1

# calculando a média do vetor
mean(div(y))
```

Perceba que não é tão difícil visualizar o que foi executado nesse código, pois temos apenas duas funções, mas se precisarmos aplicar mais de duas funções? O Código poderia ficar poluído e de difícil leitura. Por exemplo, se for aplicar quatro funções a um vetor: `funcao1(funcao2(funcao3(funcao4(y))))`. O operador pode melhorar a leitura dessas tarefas. Veja abaixo como podemos solucionar o problema anterior com o pipe ` %>% `.

```{r}
set.seed(100)

# criando o vetor
y <- rnorm(20, 10, 1) # 20 números com média 10 e desvio 1

# calculando a média do vetor
y %>% div() %>% mean()

# se preferir um abaixo do outro:
y %>% 
  div() %>% 
  mean()
```

Então, como lemos esse código? Dessa maneira: "Pegue o vetor y, aplique a função div e depois use a função mean". Portanto, eu entendo que operador `pipe - %>% ` vai ajudar quando você precisar usar várias funções aninhadas. 

### Importação dos dados

Inicialmente, precisamos importar a base de dados que foi criada na parte 1 deste curso. 

```{r}
dados <- read.csv("dados.csv", header = TRUE, sep = "")
```

Antes de trabalhar com esses dados, vamos visualizar as 10 primeiras linhas: 

```{r}
# visualizando a tabela - dados
dados[1:10,]
```

Agora, vamos entender a biblioteca `dplyr`. Ela se baseia em cinco verbos, tais quais:

  - `mutate()` cria novas variáveis a partir das existentes
  - `select()` seleciona variáveis a partir dos seus nomes
  - `filter()` seleciona as observações com base em seus valores
  - `summarise()` reduz os múltiplos valores em um resumo
  - `arrange()` reordena as observações.

Todos essas funções combinam com a função `group_by()` que agrupa as observações. 

#### select()

Vamos selecionar apenas uma variável, a DataNascimento:

```{r}
dados %>% 
  select(DataNascimento)
```

Perceba que o ` %>% ` serve para melhorar a leitura do código. Se você não quiser utilizá-lo, o código correto é:

```{r}
select(dados, DataNascimento)
```

Então, fica a seu critério. 

Continuando, vamos selecionar duas variáveis: `sexo` e `idade`:

```{r}
dados %>% 
  select(sexo, idade)
```

#### Exercício: Selecione as colunas referentes ao sexo, idade, carreira e a base de cálculo mensal

```{r}

```

```{r}
dados %>% 
  select(sexo, idade, carreira, BaseCalculoMensal)
```

#### filter()

A função `filter()` é fundamental quando necessitamos realizar um filtro nas observações. Ela utiliza-se de condições lógicas. Vamos estudar com um exemplo. Quero filtrar apenas os solteiros, isto é, peço ao R que me mostre a tabela de dados apenas com os solteiros:

```{r}
dados %>% 
  filter(EstadoCivil == "solteir")
```

Sua vez: Filtre as pessoas que não são divorciadas:

```{r}

```

```{r}
dados %>% 
  filter(EstadoCivil != "divociad")
```

Posso utilizar mais de uma condição lógica dentro de `filter()`? Sim! Veja no exemplo a seguir que faço o filtro de solteiro e professor:

```{r}
# Filtrando os soteiros e Professores
dados %>% 
  filter(EstadoCivil == "solteir", carreira == "PROFESSOR")
```

Agora, vou filtrar os casados com mais de 30 anos. Para tanto, usarei a função `filter()` com EstadoCivil e idade, atribuindo as condições necessárias:

```{r}
dados %>% 
  filter(EstadoCivil == "casad", idade > 30)
```

Perceba que a coluna EstadoCivil se torna desnecessária, pois o seu valor não muda. Desse modo, posso aplicar o mesmo código acima junto com a função `select()` retirando o EstadoCivil:

```{r}
dados %>% 
  filter(EstadoCivil == "casad", idade > 30) %>% 
  select(-EstadoCivil)
```

Dessa maneira, você consegue melhorar a tabela gerada. As funções do pacote `dplyr` foram criadas para você trabalhar com elas de forma conjunta.

Sua vez de praticar: Filtre os casados ou solteiros que têm entre 30 e 40 anos e são professores.

```{r}

```

```{r}
dados %>% 
  filter(EstadoCivil == "casad" | EstadoCivil == "solteir", 
         idade >= 30 & idade <= 40, carreira == "PROFESSOR") %>% 
  select(-carreira)
```

Podemos também realizar a operação de filtro e selecionar colunas específicas. Por exemplo, se eu quiser filtrar as pessoas com idade entre 50 e 60 anos que são solteiras ou casadas, e selecionar apenas as variáveis idade, EstadoCivil, temposervico e BaseCalculoMensal:

```{r}
dados %>% 
  filter(EstadoCivil == "casad" | EstadoCivil == "solteir",
         idade >= 50 & idade <= 60) %>% 
  select(idade, EstadoCivil, temposervico, BaseCalculoMensal)
```

Então, posso selecionar ou excluir na função `select()`. Se eu colocar o `-` antes da variável, ela é excluída, caso contrário, estou selecionando-a. 

Certo de que podemos filtar e selecionar no mesmo código. Peço que façam o seguinte exercício:
Filtre pelo sexo feminino e EstadoCivil solteiro, ao passo que seleciona as carreira e BaseCalculoMensal

```{r}

```

```{r}
dados %>% 
  filter(sexo == "feminino", EstadoCivil == "solteir") %>% 
  select(carreira, BaseCalculoMensal)
```

Agora, faça este exercício: filtre pelo EstadoCivil divorciado ou separado judicialmente com menos 50 anos ou menos de idade, e selecionando sexo, EstadoCivil, carreira, idade e Base de Cálculo

```{r}

```

```{r}
dados %>% 
  filter(EstadoCivil == "divorciad" | EstadoCivil == "sepjudicialmente", idade <= 50) %>% 
  select(sexo, EstadoCivil, carreira, idade, BaseCalculoMensal)

```

Às vezes, temos interesse em filtar excluindo uma classe, como no exemplo a seguir em que eu desejo filtar quem não é casado e que tem mais de 40 anos. Ainda, seleciono o sexo, EstadoCivil, idade, carreira e BaseCalculoMensal:

```{r}
dados %>% 
  filter(EstadoCivil != "casad", idade > 40) %>% 
  select(sexo, EstadoCivil, carreira, idade, BaseCalculoMensal)
```

Certo de que você conseguiu entender as funções `filter()` e `select()`, faça o exercício abaixo:

Faça uma tabela que filtra as pessoas com Estado Civil casado, união estável ou  solteiro que têm mais de 50 anos de idade e que recebem entre de 2.000 e 3.000 mensais, e imprime o sexo, idade, estado civil, carreira e base de calculo mensal

```{r}

```

```{r}
dados %>% 
  filter(EstadoCivil == "casad" | EstadoCivil == "uniaoestavel" | EstadoCivil == "solteir", idade > 50, BaseCalculoMensal >= 2000 & BaseCalculoMensal <= 3000) %>% 
  select(sexo, idade, EstadoCivil, carreira, BaseCalculoMensal)
```

Exercício: Repita o exercício anterior para as pessoas que recebem mais de R$3.000

```{r}

```

```{r}
dados %>% 
  filter(EstadoCivil == "casad" | EstadoCivil == "uniaoestavel" | EstadoCivil == "solteir", idade > 50, BaseCalculoMensal >= 3000) %>% 
  select(sexo, idade, EstadoCivil, carreira, BaseCalculoMensal)
```

#### arrange()
 
Nesta parte vamos aprender a ordenar uma tabela de dados. A função de ordenação é `arrange()`. Abaixo, vou ordenar nossa tabela pela idade:

```{r}
dados %>% 
  arrange(idade)
```

A ordenação é crescente, isto é, do menor para o maior. Essa função é muito útil, pois nos ajuda a visualizar melhor a tabela e encontrar os valores de forma mais visual. 

O interessante é que podemos pedir a ordenação por mais de uma variável. Por exemplo: ordenando a tabela de dados a partir da idade e da BaseCalculoMensal:

```{r}
dados %>% 
  arrange(idade, BaseCalculoMensal)
```

Essa função, `arrange()` permite que façamos a ordenação de maneira descrescente, através da utilização da função desc() atribuída à variável de interesse. No caso em questão, vamos realizar a ordenação de forma decrescente para a idade e de forma crescente para a BaseCalculoMensal:

```{r}
dados %>% 
  arrange(desc(idade), BaseCalculoMensal)
```

Sua vez de praticar: Faça um filtro das pessoas casadas, solteiras e viúvas; ordene de forma descrescente pela BaseCalculoMensal e de forma crescente pela idade e pelo temposervico; e mostre as variáveis: idade, EstadoCivil, temposervico, BaseCalculoMensal:
```{r}

```

#### mutate()

A função `mutate()` permite que você crie novas variáveis a partir das existentes. Vamos ver na prática: criando uma coluna que representa a base de calculo para 6 meses.

```{r}
dados %>% 
  mutate(BaseCalculo6meses = BaseCalculoMensal * 6)
```

Posso selecionar apenas a profissão, a base de cálculo mensal e vamos criar a coluna base de cálculo para 6 meses

```{r}
dados %>% 
  mutate(BaseCalculo6meses = BaseCalculoMensal * 6) %>% 
  select(idade, BaseCalculoMensal, BaseCalculo6meses)
```

Sua vez de praticar:
Exercício: Filtre os solteiros com idade entre 30 e 50 anos; crie a coluna Base de Cálculo Anual; ordene de forma crescente pela idade e BaseCalculo6meses; e mostre o sexo, a idade, a carreira e a BaseCalculo6meses

```{r}
dados %>% 
  filter(EstadoCivil == "solteir", idade >= 30 & idade <= 50) %>% 
  mutate(BaseCalculo6meses = BaseCalculoMensal * 13) %>% 
  arrange(idade, BaseCalculo6meses) %>% 
  select(sexo, idade, carreira, BaseCalculo6meses)
```
      
#### summarize()

A função `summarise()` tem a utilidade de criar tabelas com as estatísticas descritivas. A partir dela, criamos uma tabela com diversas funções estatísticas que serão úteis para sumarizar os dados. 

Veja abaixo como faço para calcular a média dos da BaseCalculoMensal:

```{r}
dados %>% 
  summarize(media_Base = mean(BaseCalculoMensal))

```

Deu erro! Você já sabe o porquê. A razão disso ter acontecido é que existe NA (dados omissos) em nossa tabela de dados. Diante dessa informação, eu já deveria ter pedido para omitir as pessoas com `NA`. Faço isso abaixo com a função `na.omit()`:

```{r}
dados %>% 
  na.omit() %>% 
  summarize(media_Base = mean(BaseCalculoMensal))
```

Acontece que a utilização de `summarize()` para calcular apenas uma estatística não é interessante. Vou mostrar como você poderá criar uma tabela com diversas estatísticas. 
A função summarize se torna muito útil quando se utiliza a função group_by(). Veja, portanto, como apresentar a média da base de cálculo mensal por sexo:

```{r}
dados %>% 
  na.omit() %>% 
  group_by(sexo) %>% 
  summarize(media = mean(BaseCalculoMensal))
```

Antes de continuar com as estatísticas, vamos criar uma nova base sem os `NA`. 

```{r}
dados <- na.omit(dados)
# conferir se tem NA
which(is.na(dados))
```

Como faço para adicionar outras estatísticas? Basta pedir na função summarise()
# Posso adicionar outras estatísticas, como por ex. o desvio-padrão e a quantidade
dados %>% 
  group_by(sexo) %>% 
  summarize(quantidade = n(), media = mean(BaseCalculoMensal), desvio_padrao = sd(BaseCalculoMensal))

# Vamos usar outro grupo, o Estado Civil
dados %>% 
  group_by(EstadoCivil) %>% 
  summarize(quantidade = n(), media = mean(BaseCalculoMensal), desvio_padrao = sd(BaseCalculoMensal))

# Posso usar mais de um grupo, sexo e Estado Civil
dados %>% 
  group_by(sexo, EstadoCivil) %>% 
  summarize(quantidade = n(), media = mean(BaseCalculoMensal), desvio_padrao = sd(BaseCalculoMensal))

# Vamos fazer por carreira
dados %>% 
  group_by(carreira) %>% 
  summarize(quantidade = n(), media = mean(BaseCalculoMensal), desvio_padrao = sd(BaseCalculoMensal))

# São muitas linhas. Vamos salvar como carreiras_base
carreiras_base <- dados %>% 
  group_by(carreira) %>% 
  summarize(quantidade = n(), media = mean(BaseCalculoMensal), desvio_padrao = sd(BaseCalculoMensal))

# Vamos fazer uma ordenação
arrange(carreiras_base, media)
# Pela ordem descrescente
arrange(carreiras_base, desc(media))
  
###### Faça uma tabela com a quantidade, a média, mediana, desvio-padrão, mínimo, máximo da idade e da Base de Cálculo Mensal

dados %>% 
  summarize(quantidade = n(), media_idade = mean(idade), mediana_idade = median(idade), desvio_idade = sd(idade), min_idade = min(idade), max_idade = max(idade))

##### Repita o ex. anterior sendo que apresente por sexo
dados %>% 
  group_by(sexo) %>% 
  summarize(quantidade = n(), media_idade = mean(idade), mediana_idade = median(idade), desvio_idade = sd(idade), min_idade = min(idade), max_idade = max(idade))

##### Exercício: Faça o mesmo, sendo que com os divorciados ou viuvos
dados %>% 
  group_by(sexo) %>% 
  filter(EstadoCivil == "divorciad" | EstadoCivil == "viuv") %>% 
  summarize(quantidade = n(), media_idade = mean(idade), mediana_idade = median(idade), desvio_idade = sd(idade), min_idade = min(idade), max_idade = max(idade))

##### Exercício: faça uma tabela ordenada que separa por sexo e estado civil e apresenta a quantidade, a média da base de cálculo mensal e da idade e o desvio-padrão da base e da idade

dados %>% 
  group_by(sexo, EstadoCivil) %>% 
  select(sexo, EstadoCivil, idade, BaseCalculoMensal) %>% 
  summarize(n = n(), media_base = mean(BaseCalculoMensal), media_idade = mean(idade), desvio_base = sd(BaseCalculoMensal), desvio_idade = sd(idade)) %>% 
  arrange()

#####

